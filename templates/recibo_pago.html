{% extends "layout.html" %}
{% block content %}
<div class="container d-flex justify-content-center mt-3">
    <div class="card p-4 shadow-sm" style="width: 100%; max-width: 500px; border: 1px dashed #000;" id="printableReceipt">
        <div class="text-center mb-3">
            <h4 class="fw-bold mb-0">{{ config.nombre_acueducto }}</h4>
            <p class="small mb-0">NIT: {{ config.nit }}</p>
            <p class="small">COMPROBANTE DE PAGO OFICIAL</p>
        </div>

        <div class="row small mb-3">
            <div class="col-6">
                <strong>Socio:</strong> {{ predio.dueno.nombre }}<br>
                <strong>Cuenta:</strong> {{ predio.numero_cuenta }}
            </div>
            <div class="col-6 text-end">
                <strong>Fecha:</strong> {{ fecha_pago.strftime('%d/%m/%Y %H:%M') }}<br>
                <strong>Recibo N°:</strong> {{ grupo_id }}
            </div>
        </div>

        <table class="table table-sm small">
            <thead class="table-light">
                <tr>
                    <th>Periodo</th>
                    <th>L. Ant / Act</th>
                    <th class="text-end">Vlr. Mes</th>
                </tr>
            </thead>
            <tbody>
                {% set total = 0 %}
                {% for f in facturas %}
                <tr>
                    <td>{{ f.lectura.mes }}/{{ f.lectura.anio }}</td>
                    <td>{{ f.lectura.lectura_anterior }} - {{ f.lectura.lectura_actual }} ({{ f.lectura.consumo_mes }}m³)</td>
                    <td class="text-end">$ {{ "{:,.0f}".format(f.total_a_pagar) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="border-top pt-2 mt-2">
            <div class="d-flex justify-content-between">
                <span class="fw-bold fs-5">TOTAL PAGADO:</span>
                <span class="fw-bold fs-5">$ {{ "{:,.0f}".format(total_pagado) }}</span>
            </div>
        </div>

        <div class="text-center mt-4 small">
            <p>¡Gracias por estar al día con el agua!<br>Consérvese este recibo para cualquier reclamo.</p>
        </div>

        <div class="d-print-none mt-4 text-center">
    <button onclick="imprimirYRegresar()" class="btn btn-primary btn-lg">
        <i class="bi bi-printer"></i> Imprimir y Volver al POS
    </button>
    <a href="{{ url_for('modulo_pos') }}" class="btn btn-outline-secondary btn-lg">Cancelar / Volver</a>
</div>

<script>
function imprimirYRegresar() {
    // 1. Abrimos el diálogo de impresión
    window.print();
    
    // 2. Este evento se dispara después de que la ventana de impresión se cierra
    // (ya sea porque el usuario imprimió o canceló)
    window.onafterprint = function() {
        window.location.href = "{{ url_for('modulo_pos') }}";
    };

    // Respaldo para navegadores que no soportan onafterprint
    setTimeout(function() {
        if (confirm("¿Desea volver al POS para atender a otro socio?")) {
            window.location.href = "{{ url_for('modulo_pos') }}";
        }
    }, 1000);
}
</script>

<style>
/* Ajustes para que el recibo se vea perfecto en papel */
@media print {
    body { background: white; }
    .navbar, .d-print-none, .footer { display: none !important; }
    .card { border: none !important; shadow: none !important; }
    #printableReceipt { width: 100%; margin: 0; padding: 0; }
}
</style>

{% endblock %}